---
title: "시계열 분석"
output:
  md_document:
    variant: markdown_github
---

```{r}
rm(list=ls())
```

### 시계열 분석

#### 1. 시계열 데이터

-   

    ts(data, start, frequency)\\

    :   시계열 데이터로 변환

    -   start : 시작 날짜

    -   frequency : 주기 (4:분기별 / 12:월별 / 365:일별)

```{r}
ts(1:10, frequency = 4, start = c(1959, 2))
```

-   

    getSymbols(Symbols, src, from, to) \# quantmod 패키지\\

    :   야후 파이낸스 데이터 불러오기

    -   Symbols : 기업

    -   src : 사이트

    -   from, to : from\~to

```{r}
library(quantmod)

# META의 파이낸스 데이터
getSymbols(Symbols = 'META', src='yahoo',from=as.Date('2015-08-01'),to=as.Date('2016-08-31'))

head(META)
plot(META)
```

-   

    aggregate(x, nfrequency, FUN)\\

    :   서로 다른 주기의 데이터에 대해 일련의 연산 수행하여 주기를 맞춤

    -   nfrequency : 연산 단위 (1:년도별 / 4:분기별,...)

```{r}
aggregate(AirPassengers, nfrequency = 4, FUN = sum)
```

#### 예제

시계열 데이터의 요소 : 추세요인, 계절요인, 순환요인, 불규칙요인

```{r}
# 나일강 연간 유입량 데이터
Nile
plot(Nile)
```

=\> 추세가 약간 보이는 것 같다.

```{r}
# 영국 내의 월별 폐질환 사망자 데이터
ldeaths
plot(ldeaths)
```

=\> 계절성이 띄는 것이 보인다.

#### 2. 시계열 분해

-   

    decompose(x, type=c('additive','multiplicative'),filter=NULL)\\

    :   이동평균선을 이용해 시계열을 계절성, 추세, 불규칙 성분으로 분해.

    -   x : 시계열

    -   type : additive=\> T+S+e / multiplicative =\> T\*S\*e

```{r}
# 계절요인 분해시계열
ldeaths.decompose <- decompose(ldeaths) # 데이터에서 4가지 요인을 분해

# 계절요인으로 분해된 부분
ldeaths.decompose$seasonal
```

-   시각화

```{r}
plot(ldeaths.decompose)
```

-   특정 요인 제거

※ 특정 요인이 있다고 판단될 경우, 특정요인을 빼 적절한 조정 가능

```{r}
# 계절 요인 제외
ldeaths.decompose.adj <- ldeaths - ldeaths.decompose$seasonal

par(mfrow=c(1,2))
plot(ldeaths, main='raw')
plot(ldeaths.decompose.adj, main='raw-seasonal')
```

#### 3. 차분

평균이 일정하지 않은(추세 존재) 비정상시계열 =\> 차분

-   diff(x, lag=1, differences=1)

    -   lag : 시차 설정

    -   differences : 차분 차수 설정

```{r}
# 1차 차분
Nile.diff_1 <- diff(Nile, differences = 1)
plot(Nile.diff_1)
```

```{r}
# 2차 차분
Nile.diff_2 <- diff(Nile, differences = 2)
plot(Nile.diff_2)
```

=\> 2차 차분 후 평균과 분산이 시간이 지남에 따라 일정한 정상성을 띔

-   ACF(자기상관함수 그래프)

    -   acf(x, lag.max)

```{r}
acf(Nile.diff_2, lag.max = 20)
acf(Nile.diff_2, lag.max = 20, plot = FALSE)
```

=\> lag 2에서 절단되므로 ARIMA(0,1)

-   PACF(부분자기상관함수 그래프)

    -   pacf(x, lag.max)

```{r}
pacf(Nile.diff_2, lag.max = 20)
pacf(Nile.diff_2, lag.max = 20, plot = FALSE)
```

=\> lag 9에서 절단되므로 ARIMA(8,0)

#### 4. ARIMA 모형

-   

    auto.arima(x) \# forecast 패키지\\

    :   자동으로 ARIMA(p,d,q) 설정

```{r}
#install.packages('forecast')
library(forecast)

auto.arima(Nile)
```

=\> 자동으로 ARIMA(1,1,1) 선택

-   arima(x, oreder=c(p,d,q))

    -   order : ARIMA(p,d,q) 설정

```{r}
Nile.arima <- arima(Nile, order = c(1,1,1))
Nile.arima
```

-   

    forecaset(object, ...) \# forecast 함수\\

    :   arima 결과를 활용한 forecast 예측

```{r}
# 10개년도 예측
Nile.forecast <- forecast(Nile.arima,h=10)
Nile.forecast

plot(Nile.forecast)
```

파란 영역 : 80% 신뢰구간

회색 영역 : 95% 신뢰구간

-   모형 진단(모형 타당성 검정)

1.  잔차가 백색 잡음(white noise) 검정\
    (모형의 잔차가 불규칙적이고, 독립적)

```{r}
# 1) 자기상관함수에 의한 모형 진단
tsdiag(Nile.arima)
```

=\> ACF(자기상관함수)에서 모든 lag가 파란선 안에 들어와있음\
= 자기 상관관계 없음 (불규칙성)

=\> p-value 값이 0 이상에 분포\
= 모델 적합

```{r}
# 2) Box-Ljung에 의한 잔차항 모형 진단
Box.test(Nile.arima$residuals, type = 'Ljung')
```

=\> [p-value \> 0.05]{.underline}이므로 모델 적합([모형이 통계적으로 적절]{.underline})
