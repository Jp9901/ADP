``` r
rm(list = ls())
```

### 생존분석

#### 1. Kaplan-Meier

``` r
#install.packages('asaur')
library(survival)
library(dplyr)
```

    ## 
    ## Attaching package: 'dplyr'

    ## The following objects are masked from 'package:stats':
    ## 
    ##     filter, lag

    ## The following objects are masked from 'package:base':
    ## 
    ##     intersect, setdiff, setequal, union

``` r
library(ggplot2)
```

-   생존분석 data

    -   Surv(time, time2, event, type, origin)

        -   time,time2 : \[0~time) or \[time,time2)

        -   event : (alive,dead) = (0,1) or (FALSE,TRUE) or (1,2)

        -   type : 중도절단 종류
            (‘right’,‘left’,‘counting’,‘interval’,…)

<img src="images/스크린샷%202024-04-08%2015.07.10.png"
width="372" />

``` r
t1 <- c(2,1,2,4) # 관측 시작 time
t2 <- c(8,5,10,9) # 관측 종료 time
st <- c(1,0,0,1) # status (0=censoring / 1=dead)
Surv(time=t1, time2=t2, event=st) # type = 'counting'
```

    ## [1] (2, 8]  (1, 5+] (2,10+] (4, 9]

``` r
t3 <- c(6,4,8,5) # 위와 동일(관측 시작 time을 동일하게 고정)
Surv(t3,st)
```

    ## [1] 6  4+ 8+ 5

-   survfit(formula)\\  
    생존 함수

    -   formula : Surv(time,event) ~ covariates

``` r
survfit(Surv(t1,t2,st)~1)
```

    ## Call: survfit(formula = Surv(t1, t2, st) ~ 1)
    ## 
    ##      n events median 0.95LCL 0.95UCL
    ## [1,] 4      2      9       8      NA

``` r
summary(survfit(Surv(t1,t2,st)~1))
```

    ## Call: survfit(formula = Surv(t1, t2, st) ~ 1)
    ## 
    ##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
    ##     8      3       1    0.667   0.272       0.2995            1
    ##     9      2       1    0.333   0.272       0.0673            1

-   Kaplan Meier curve

``` r
plot(survfit(Surv(t1,t2,st)~1),
     xlab='time',ylab='survival prob')
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-5-1.png)

``` r
plot(survfit(Surv(t3,st)~1),
     xlab='time',ylab='survival prob')
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-5-2.png)

=\> 시작지점이 달라져 두 그래프가 달라짐. 하지만 같은 그래프라 생각해도
무관

#### 예제

``` r
library(asaur) # Applied Survival Analysis Using R

data("pharmacoSmoking")
head(pharmacoSmoking)
```

    ##    id ttr relapse         grp age gender     race employment yearsSmoking
    ## 1  21 182       0   patchOnly  36   Male    white         ft           26
    ## 2 113  14       1   patchOnly  41   Male    white      other           27
    ## 3  39   5       1 combination  25 Female    white      other           12
    ## 4  80  16       1 combination  54   Male    white         ft           39
    ## 5  87   0       1 combination  45   Male    white      other           30
    ## 6  29 182       0 combination  43   Male hispanic         ft           30
    ##   levelSmoking ageGroup2 ageGroup4 priorAttempts longestNoSmoke
    ## 1        heavy     21-49     35-49             0              0
    ## 2        heavy     21-49     35-49             3             90
    ## 3        heavy     21-49     21-34             3             21
    ## 4        heavy       50+     50-64             0              0
    ## 5        heavy     21-49     35-49             0              0
    ## 6        heavy     21-49     35-49             2           1825

``` r
# grp에 따른 생존분석
df1 <- survfit(Surv(ttr,relapse)~grp, data=pharmacoSmoking)
df1
```

    ## Call: survfit(formula = Surv(ttr, relapse) ~ grp, data = pharmacoSmoking)
    ## 
    ##                  n events median 0.95LCL 0.95UCL
    ## grp=combination 61     37     65      50      NA
    ## grp=patchOnly   64     52     23      14      56

``` r
summary(df1, times=c(0,50,100,150)) # 원하는 시간에서의 생존확률
```

    ## Call: survfit(formula = Surv(ttr, relapse) ~ grp, data = pharmacoSmoking)
    ## 
    ##                 grp=combination 
    ##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
    ##     0     61       4    0.934  0.0317        0.874        0.999
    ##    50     38      20    0.607  0.0625        0.496        0.742
    ##   100     29       8    0.475  0.0639        0.365        0.619
    ##   150     25       4    0.410  0.0630        0.303        0.554
    ## 
    ##                 grp=patchOnly 
    ##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
    ##     0     64       8    0.875  0.0413        0.798        0.960
    ##    50     24      32    0.375  0.0605        0.273        0.515
    ##   100     17       8    0.250  0.0541        0.164        0.382
    ##   150     14       2    0.219  0.0517        0.138        0.348

``` r
plot(df1, col=c('red','blue')) # conf.int=T : 신뢰구간
legend('topright',lty=1,col=c('red','blue'),
       legend = c('combination','patch only'))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-8-1.png)

※ 비례위험가정 \\  
위험비(집단 A와 집단 B의 위험함수의 비율)가 일정하게 유지된다.

``` r
data("pancreatic2")
df2 <- survfit(Surv(os,status)~stage, data = pancreatic2)
plot(df2, col=c('red','blue'))
legend("topright",lty=1, col=c("red","blue"),legend = c("Locally Advanced","Metastatic"))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-9-1.png)

=\> 400부근과 600부근에서 비례위험 가정 위배. 따라서 시간에 대해 별도의
배려를 해야한다.
