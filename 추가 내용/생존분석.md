``` r
rm(list = ls())
```

### 생존분석

\# **survival 패키지**

#### 1. 생존분석 기본 함수

``` r
#install.packages('asaur')
library(survival)
library(dplyr)
```

    ## 
    ## Attaching package: 'dplyr'

    ## The following objects are masked from 'package:stats':
    ## 
    ##     filter, lag

    ## The following objects are masked from 'package:base':
    ## 
    ##     intersect, setdiff, setequal, union

``` r
library(ggplot2)
```

-   Surv(time, time2, event, type, origin)

    -   time,time2 : \[0~time) or \[time,time2)

    -   event : (alive,dead) = (0,1) or (FALSE,TRUE) or (1,2)

    -   type : 중도절단 종류 (‘right’,‘left’,‘counting’,‘interval’,…)

<img src="images/스크린샷%202024-04-08%2015.07.10.png"
width="372" />

``` r
t1 <- c(2,1,2,4) # 관측 시작 time
t2 <- c(8,5,10,9) # 관측 종료 time
st <- c(1,0,0,1) # status (0=censoring / 1=dead)
Surv(time=t1, time2=t2, event=st) # type = 'counting'
```

    ## [1] (2, 8]  (1, 5+] (2,10+] (4, 9]

``` r
t3 <- c(6,4,8,5) # 위와 동일(관측 시작 time을 동일하게 고정)
Surv(t3,st)
```

    ## [1] 6  4+ 8+ 5

-   survfit(formula)

    :생존 함수

    -   formula : Surv(time,event) ~ covariates

        ※ covariates는 범주형 변수가 적합.  
        하지만 대상의 수가 많지 않아 통계적으로 유의x or 범주형 변수의
        변환 기준을 판단할 때 =\> 연속형 변수 이용

``` r
survfit(Surv(t1,t2,st)~1)
```

    ## Call: survfit(formula = Surv(t1, t2, st) ~ 1)
    ## 
    ##      n events median 0.95LCL 0.95UCL
    ## [1,] 4      2      9       8      NA

``` r
summary(survfit(Surv(t1,t2,st)~1))
```

    ## Call: survfit(formula = Surv(t1, t2, st) ~ 1)
    ## 
    ##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
    ##     8      3       1    0.667   0.272       0.2995            1
    ##     9      2       1    0.333   0.272       0.0673            1

-   survdiff(formula, data, subset, na.action, rho=0, timefix=TRUE)\\  
    log-rank test (생존 확률이 관심있는 변수에 따라 차이가 있는지
    검정하는 방법)

    -   subset : 조건에 맞는 행 추출

    -   na.action : 결측치 처리

    -   rho, timefix : *(생략)*

H0 : 두 집단의 위험함수가 동일하다.

``` r
head(lung)
```

    ##   inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss
    ## 1    3  306      2  74   1       1       90       100     1175      NA
    ## 2    3  455      2  68   1       0       90        90     1225      15
    ## 3    3 1010      1  56   1       0       90        90       NA      15
    ## 4    5  210      2  57   1       1       90        60     1150      11
    ## 5    1  883      2  60   1       0      100        90       NA       0
    ## 6   12 1022      1  74   1       1       50        80      513       0

``` r
survdiff(Surv(time,status)~sex,data=lung)
```

    ## Call:
    ## survdiff(formula = Surv(time, status) ~ sex, data = lung)
    ## 
    ##         N Observed Expected (O-E)^2/E (O-E)^2/V
    ## sex=1 138      112     91.6      4.55      10.3
    ## sex=2  90       53     73.4      5.68      10.3
    ## 
    ##  Chisq= 10.3  on 1 degrees of freedom, p= 0.001

=\> p-value \< 0.05이므로 귀무가설 ’두 집단의 위험함수가 동일하다’를
기각.

#### 2. Kaplan-Meier

-   Kaplan Meier curve

``` r
plot(survfit(Surv(t1,t2,st)~1),
     xlab='time',ylab='survival prob')
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-6-1.png)

``` r
plot(survfit(Surv(t3,st)~1),
     xlab='time',ylab='survival prob')
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-6-2.png)

=\> 시작지점이 달라져 두 그래프가 달라짐. 하지만 같은 그래프라 생각해도
무관

#### 예제

-   EDA

``` r
library(asaur) # Applied Survival Analysis Using R

data("pharmacoSmoking")
head(pharmacoSmoking)
```

    ##    id ttr relapse         grp age gender     race employment yearsSmoking
    ## 1  21 182       0   patchOnly  36   Male    white         ft           26
    ## 2 113  14       1   patchOnly  41   Male    white      other           27
    ## 3  39   5       1 combination  25 Female    white      other           12
    ## 4  80  16       1 combination  54   Male    white         ft           39
    ## 5  87   0       1 combination  45   Male    white      other           30
    ## 6  29 182       0 combination  43   Male hispanic         ft           30
    ##   levelSmoking ageGroup2 ageGroup4 priorAttempts longestNoSmoke
    ## 1        heavy     21-49     35-49             0              0
    ## 2        heavy     21-49     35-49             3             90
    ## 3        heavy     21-49     21-34             3             21
    ## 4        heavy       50+     50-64             0              0
    ## 5        heavy     21-49     35-49             0              0
    ## 6        heavy     21-49     35-49             2           1825

``` r
# 시간에 대한 히스토그램
with(pharmacoSmoking,hist(ttr))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-8-1.png)

=\> 0 부근 : 초기 포기자, 200 부근 : 연구 종료에 따른 censoring

``` r
# 재발여부(0:censoring / 1:치료) 비율
with(pharmacoSmoking,table(relapse))
```

    ## relapse
    ##  0  1 
    ## 36 89

``` r
with(pharmacoSmoking,table(relapse,ttr))
```

    ##        ttr
    ## relapse  0  1  2  3  4  5  6  7  8 10 12 14 15 16 20 21 25 28 30 40 42 45 49 50
    ##       0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
    ##       1 12  5  6  1  3  2  1  1  3  1  2  7  4  1  1  2  1  3  3  1  1  1  1  1
    ##        ttr
    ## relapse 56 60 63 65 75 77 80 84 100 105 110 140 155 170 182
    ##       0  0  0  0  0  0  0  0  0   0   0   0   0   0   0  36
    ##       1  5  2  2  1  1  2  1  1   1   1   1   4   1   2   0

=\> 연구 종료를 제외하면 censoring이 없다.

※ 주의사항 : 연구결과가 좋더라도 <u>치료군의 중도탈락이 의미가 있을
정도로 많다면</u> 그 결과는 신뢰하지 않는 것이 바람직하다. (중도탈락도
중요한 결과를 갖지만 보통 결과에 제시하지 않음.)

-   생존분석

``` r
# grp에 따른 생존분석
df1 <- survfit(Surv(ttr,relapse)~grp, data=pharmacoSmoking)
df1
```

    ## Call: survfit(formula = Surv(ttr, relapse) ~ grp, data = pharmacoSmoking)
    ## 
    ##                  n events median 0.95LCL 0.95UCL
    ## grp=combination 61     37     65      50      NA
    ## grp=patchOnly   64     52     23      14      56

``` r
summary(df1, times=c(0,50,100,150)) # 원하는 시간에서의 생존확률
```

    ## Call: survfit(formula = Surv(ttr, relapse) ~ grp, data = pharmacoSmoking)
    ## 
    ##                 grp=combination 
    ##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
    ##     0     61       4    0.934  0.0317        0.874        0.999
    ##    50     38      20    0.607  0.0625        0.496        0.742
    ##   100     29       8    0.475  0.0639        0.365        0.619
    ##   150     25       4    0.410  0.0630        0.303        0.554
    ## 
    ##                 grp=patchOnly 
    ##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
    ##     0     64       8    0.875  0.0413        0.798        0.960
    ##    50     24      32    0.375  0.0605        0.273        0.515
    ##   100     17       8    0.250  0.0541        0.164        0.382
    ##   150     14       2    0.219  0.0517        0.138        0.348

``` r
plot(df1, col=c('red','blue')) # conf.int=T : 신뢰구간
legend('topright',lty=1,col=c('red','blue'),
       legend = c('combination','patch only'))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-12-1.png)

※ 비례위험가정 \\  
위험비(집단 A와 집단 B의 위험함수의 비율)가 일정하게 유지된다.

``` r
data("pancreatic2")
df2 <- survfit(Surv(os,status)~stage, data = pancreatic2)
plot(df2, col=c('red','blue'))
legend("topright",lty=1, col=c("red","blue"),legend = c("Locally Advanced","Metastatic"))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-13-1.png)

=\> 400부근과 600부근에서 비례위험 가정 위배. 따라서 시간에 대해 별도의
배려를 해야한다.

#### 2. Cox 분석

``` r
head(pharmacoSmoking)
```

    ##    id ttr relapse         grp age gender     race employment yearsSmoking
    ## 1  21 182       0   patchOnly  36   Male    white         ft           26
    ## 2 113  14       1   patchOnly  41   Male    white      other           27
    ## 3  39   5       1 combination  25 Female    white      other           12
    ## 4  80  16       1 combination  54   Male    white         ft           39
    ## 5  87   0       1 combination  45   Male    white      other           30
    ## 6  29 182       0 combination  43   Male hispanic         ft           30
    ##   levelSmoking ageGroup2 ageGroup4 priorAttempts longestNoSmoke
    ## 1        heavy     21-49     35-49             0              0
    ## 2        heavy     21-49     35-49             3             90
    ## 3        heavy     21-49     21-34             3             21
    ## 4        heavy       50+     50-64             0              0
    ## 5        heavy     21-49     35-49             0              0
    ## 6        heavy     21-49     35-49             2           1825

``` r
# grp에 따른 생존 확률
df <- coxph(Surv(ttr,relapse)~grp,data=pharmacoSmoking)
summary(df)
```

    ## Call:
    ## coxph(formula = Surv(ttr, relapse) ~ grp, data = pharmacoSmoking)
    ## 
    ##   n= 125, number of events= 89 
    ## 
    ##                coef exp(coef) se(coef)   z Pr(>|z|)   
    ## grppatchOnly 0.6050    1.8313   0.2161 2.8  0.00511 **
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ##              exp(coef) exp(-coef) lower .95 upper .95
    ## grppatchOnly     1.831     0.5461     1.199     2.797
    ## 
    ## Concordance= 0.581  (se = 0.027 )
    ## Likelihood ratio test= 7.99  on 1 df,   p=0.005
    ## Wald test            = 7.84  on 1 df,   p=0.005
    ## Score (logrank) test = 8.07  on 1 df,   p=0.004

=\> grp = patchOnly 는 grp = combination일 때의 Hazard Ratio가
1.8313배이다.

#### 예제

-   Martingale residual

(Cox분석에서 연속변수의 처리법)

``` r
# age변수
with(pharmacoSmoking, hist(age))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-16-1.png)

``` r
shapiro.test(pharmacoSmoking$age)
```

    ## 
    ##  Shapiro-Wilk normality test
    ## 
    ## data:  pharmacoSmoking$age
    ## W = 0.9943, p-value = 0.8981

=\> p-value\>0.05이므로 데이터가 정규 분포를 따른다고 할 수 있다.

``` r
cp1 <- coxph(Surv(ttr,relapse)~1,data=pharmacoSmoking)
pharmacoSmoking$resid <- residuals(cp1, type = 'martingale')
pharmacoSmoking %>% 
  ggplot(aes(age,resid)) + 
  geom_point()+geom_smooth() + 
  theme_classic() + 
  geom_hline(yintercept=0,col='red') +
  geom_vline(xintercept = c(34,64),lty=3,col='blue') +
  geom_vline(xintercept = c(49),lty=2,col='blue')
```

    ## `geom_smooth()` using method = 'loess' and formula = 'y ~ x'

![](생존분석_files/figure-markdown_github/unnamed-chunk-17-1.png)

resid=0은 평균 hazard, +값은 hazard\>0, -값은 반대

=\> 데이터에서 resid에 따라 age를 2개의 그룹(ageGroup2)과 4개의
그룹(ageGroup4)으로 범주화시킴

``` r
# longestNoSmoke 변수
with(pharmacoSmoking, hist(longestNoSmoke))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-18-1.png)

``` r
with(pharmacoSmoking, hist(log(longestNoSmoke+1)))
```

![](생존분석_files/figure-markdown_github/unnamed-chunk-18-2.png)

``` r
pharmacoSmoking %>% 
  ggplot(aes(log(longestNoSmoke+1),resid))+geom_point()+geom_smooth()+theme_classic()+geom_hline(yintercept = 0,col='red')
```

    ## `geom_smooth()` using method = 'loess' and formula = 'y ~ x'

![](생존분석_files/figure-markdown_github/unnamed-chunk-18-3.png)

=\> 90% 신뢰구간이 0을 완전히 벗어나지 않으므로 연속형 변수 가능

※ 해당 covariate가 주요 변수 or 대상자 수가 충분하여 범주화해도 통계적
유의성 유지=\> 범주화

``` r
cp2 <- coxph(Surv(ttr,relapse)~log(longestNoSmoke+1),data = pharmacoSmoking)
summary(cp2)
```

    ## Call:
    ## coxph(formula = Surv(ttr, relapse) ~ log(longestNoSmoke + 1), 
    ##     data = pharmacoSmoking)
    ## 
    ##   n= 125, number of events= 89 
    ## 
    ##                             coef exp(coef) se(coef)      z Pr(>|z|)  
    ## log(longestNoSmoke + 1) -0.07638   0.92646  0.04116 -1.856   0.0635 .
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ##                         exp(coef) exp(-coef) lower .95 upper .95
    ## log(longestNoSmoke + 1)    0.9265      1.079    0.8547     1.004
    ## 
    ## Concordance= 0.577  (se = 0.032 )
    ## Likelihood ratio test= 3.42  on 1 df,   p=0.06
    ## Wald test            = 3.44  on 1 df,   p=0.06
    ## Score (logrank) test = 3.47  on 1 df,   p=0.06

``` r
cp3 <- coxph(Surv(ttr,relapse)~cut_number(longestNoSmoke,n = 3),data = pharmacoSmoking)
summary(cp3)
```

    ## Call:
    ## coxph(formula = Surv(ttr, relapse) ~ cut_number(longestNoSmoke, 
    ##     n = 3), data = pharmacoSmoking)
    ## 
    ##   n= 125, number of events= 89 
    ## 
    ##                                                    coef exp(coef) se(coef)
    ## cut_number(longestNoSmoke, n = 3)(14,200]       -0.3175    0.7280   0.2558
    ## cut_number(longestNoSmoke, n = 3)(200,6.20e+03] -0.5309    0.5881   0.2588
    ##                                                      z Pr(>|z|)  
    ## cut_number(longestNoSmoke, n = 3)(14,200]       -1.241   0.2145  
    ## cut_number(longestNoSmoke, n = 3)(200,6.20e+03] -2.052   0.0402 *
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ##                                                 exp(coef) exp(-coef) lower .95
    ## cut_number(longestNoSmoke, n = 3)(14,200]          0.7280      1.374    0.4410
    ## cut_number(longestNoSmoke, n = 3)(200,6.20e+03]    0.5881      1.700    0.3541
    ##                                                 upper .95
    ## cut_number(longestNoSmoke, n = 3)(14,200]          1.2017
    ## cut_number(longestNoSmoke, n = 3)(200,6.20e+03]    0.9765
    ## 
    ## Concordance= 0.574  (se = 0.031 )
    ## Likelihood ratio test= 4.29  on 2 df,   p=0.1
    ## Wald test            = 4.34  on 2 df,   p=0.1
    ## Score (logrank) test = 4.41  on 2 df,   p=0.1
