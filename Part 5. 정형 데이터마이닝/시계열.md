``` r
rm(list=ls())
```

### 시계열 분석

#### 1. 시계열 데이터

-   ts(data, start, frequency)

    시계열 데이터로 변환

    -   start : 시작 날짜

    -   frequency : 주기 (4:분기별 / 12:월별 / 365:일별)

``` r
ts(1:10, frequency = 4, start = c(1959, 2))
```

    ##      Qtr1 Qtr2 Qtr3 Qtr4
    ## 1959         1    2    3
    ## 1960    4    5    6    7
    ## 1961    8    9   10

-   getSymbols(Symbols, src, from, to) \# quantmod 패키지\\  
    야후 파이낸스 데이터 불러오기

    -   Symbols : 기업

    -   src : 사이트

    -   from, to : from~to

``` r
library(quantmod)
```

    ## Loading required package: xts

    ## Loading required package: zoo

    ## 
    ## Attaching package: 'zoo'

    ## The following objects are masked from 'package:base':
    ## 
    ##     as.Date, as.Date.numeric

    ## Loading required package: TTR

    ## Registered S3 method overwritten by 'quantmod':
    ##   method            from
    ##   as.zoo.data.frame zoo

``` r
# META의 파이낸스 데이터
getSymbols(Symbols = 'META', src='yahoo',from=as.Date('2015-08-01'),to=as.Date('2016-08-31'))
```

    ## [1] "META"

``` r
head(META)
```

    ##            META.Open META.High META.Low META.Close META.Volume META.Adjusted
    ## 2015-08-03     93.53     95.08    92.80      94.14    29343100      94.04022
    ## 2015-08-04     93.79     94.73    93.33      94.06    20136000      93.96030
    ## 2015-08-05     95.25     97.09    95.18      96.44    29813200      96.33778
    ## 2015-08-06     97.18     98.74    94.42      95.12    42271300      95.01919
    ## 2015-08-07     95.38     95.40    93.61      94.30    23199100      94.20006
    ## 2015-08-10     95.68     95.90    93.63      94.15    21624200      94.05022

``` r
plot(META)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-3-1.png)

-   aggregate(x, nfrequency, FUN)

    서로 다른 주기의 데이터에 대해 일련의 연산 수행하여 주기를 맞춤

    -   nfrequency : 연산 단위 (1:년도별 / 4:분기별,…)

``` r
aggregate(AirPassengers, nfrequency = 4, FUN = sum)
```

    ##      Qtr1 Qtr2 Qtr3 Qtr4
    ## 1949  362  385  432  341
    ## 1950  382  409  498  387
    ## 1951  473  513  582  474
    ## 1952  544  582  681  557
    ## 1953  628  707  773  592
    ## 1954  627  725  854  661
    ## 1955  742  854 1023  789
    ## 1956  878 1005 1173  883
    ## 1957  972 1125 1336  988
    ## 1958 1020 1146 1400 1006
    ## 1959 1108 1288 1570 1174
    ## 1960 1227 1468 1736 1283

#### 예제

시계열 데이터의 요소 : 추세요인, 계절요인, 순환요인, 불규칙요인

``` r
# 나일강 연간 유입량 데이터
Nile
```

    ## Time Series:
    ## Start = 1871 
    ## End = 1970 
    ## Frequency = 1 
    ##   [1] 1120 1160  963 1210 1160 1160  813 1230 1370 1140  995  935 1110  994 1020
    ##  [16]  960 1180  799  958 1140 1100 1210 1150 1250 1260 1220 1030 1100  774  840
    ##  [31]  874  694  940  833  701  916  692 1020 1050  969  831  726  456  824  702
    ##  [46] 1120 1100  832  764  821  768  845  864  862  698  845  744  796 1040  759
    ##  [61]  781  865  845  944  984  897  822 1010  771  676  649  846  812  742  801
    ##  [76] 1040  860  874  848  890  744  749  838 1050  918  986  797  923  975  815
    ##  [91] 1020  906  901 1170  912  746  919  718  714  740

``` r
plot(Nile)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-5-1.png)

=\> 추세가 약간 보이는 것 같다.

``` r
# 영국 내의 월별 폐질환 사망자 데이터
ldeaths
```

    ##       Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
    ## 1974 3035 2552 2704 2554 2014 1655 1721 1524 1596 2074 2199 2512
    ## 1975 2933 2889 2938 2497 1870 1726 1607 1545 1396 1787 2076 2837
    ## 1976 2787 3891 3179 2011 1636 1580 1489 1300 1356 1653 2013 2823
    ## 1977 3102 2294 2385 2444 1748 1554 1498 1361 1346 1564 1640 2293
    ## 1978 2815 3137 2679 1969 1870 1633 1529 1366 1357 1570 1535 2491
    ## 1979 3084 2605 2573 2143 1693 1504 1461 1354 1333 1492 1781 1915

``` r
plot(ldeaths)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-6-1.png)

=\> 계절성이 띄는 것이 보인다.

#### 2. 시계열 분해

-   decompose(x, type=c(‘additive’,‘multiplicative’),filter=NULL)

    이동평균선을 이용해 시계열을 계절성, 추세, 불규칙 성분으로 분해.

    -   x : 시계열

    -   type : additive=\> T+S+e / multiplicative =\> T\*S\*e

``` r
# 계절요인 분해시계열
ldeaths.decompose <- decompose(ldeaths) # 데이터에서 4가지 요인을 분해

# 계절요인으로 분해된 부분
ldeaths.decompose$seasonal
```

    ##            Jan       Feb       Mar       Apr       May       Jun       Jul
    ## 1974  873.7514  896.3347  687.5431  156.5847 -284.4819 -440.0236 -519.4236
    ## 1975  873.7514  896.3347  687.5431  156.5847 -284.4819 -440.0236 -519.4236
    ## 1976  873.7514  896.3347  687.5431  156.5847 -284.4819 -440.0236 -519.4236
    ## 1977  873.7514  896.3347  687.5431  156.5847 -284.4819 -440.0236 -519.4236
    ## 1978  873.7514  896.3347  687.5431  156.5847 -284.4819 -440.0236 -519.4236
    ## 1979  873.7514  896.3347  687.5431  156.5847 -284.4819 -440.0236 -519.4236
    ##            Aug       Sep       Oct       Nov       Dec
    ## 1974 -669.8736 -678.2236 -354.3069 -185.2069  517.3264
    ## 1975 -669.8736 -678.2236 -354.3069 -185.2069  517.3264
    ## 1976 -669.8736 -678.2236 -354.3069 -185.2069  517.3264
    ## 1977 -669.8736 -678.2236 -354.3069 -185.2069  517.3264
    ## 1978 -669.8736 -678.2236 -354.3069 -185.2069  517.3264
    ## 1979 -669.8736 -678.2236 -354.3069 -185.2069  517.3264

-   시각화

``` r
plot(ldeaths.decompose)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-8-1.png)

-   특정 요인 제거

※ 특정 요인이 있다고 판단될 경우, 특정요인을 빼 적절한 조정 가능

``` r
# 계절 요인 제외
ldeaths.decompose.adj <- ldeaths - ldeaths.decompose$seasonal

par(mfrow=c(1,2))
plot(ldeaths, main='raw')
plot(ldeaths.decompose.adj, main='raw-seasonal')
```

![](시계열_files/figure-markdown_github/unnamed-chunk-9-1.png)

#### 3. 차분

평균이 일정하지 않은(추세 존재) 비정상시계열 =\> 차분

-   diff(x, lag=1, differences=1)

    -   lag : 시차 설정

    -   differences : 차분 차수 설정

``` r
# 1차 차분
Nile.diff_1 <- diff(Nile, differences = 1)
plot(Nile.diff_1)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-10-1.png)

``` r
# 2차 차분
Nile.diff_2 <- diff(Nile, differences = 2)
plot(Nile.diff_2)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-11-1.png)

=\> 2차 차분 후 평균과 분산이 시간이 지남에 따라 일정한 정상성을 띔

-   ACF(자기상관함수 그래프)

    -   acf(x, lag.max)

※ 지수적 감소 형태 or 양과 음 번갈아 반복 =\> 상성 조건을 만족

``` r
acf(Nile.diff_2, lag.max = 20)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-12-1.png)

``` r
acf(Nile.diff_2, lag.max = 20, plot = FALSE)
```

    ## 
    ## Autocorrelations of series 'Nile.diff_2', by lag
    ## 
    ##      0      1      2      3      4      5      6      7      8      9     10 
    ##  1.000 -0.626  0.100  0.067 -0.072  0.017  0.074 -0.192  0.245 -0.079 -0.153 
    ##     11     12     13     14     15     16     17     18     19     20 
    ##  0.183 -0.106  0.062  0.010 -0.096  0.134 -0.134  0.091 -0.030  0.003

=\> lag 2에서 절단되므로 q=1 =\> ARMA(0,1)

-   PACF(부분자기상관함수 그래프)

    -   pacf(x, lag.max)

``` r
pacf(Nile.diff_2, lag.max = 20)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-13-1.png)

``` r
pacf(Nile.diff_2, lag.max = 20, plot = FALSE)
```

    ## 
    ## Partial autocorrelations of series 'Nile.diff_2', by lag
    ## 
    ##      1      2      3      4      5      6      7      8      9     10     11 
    ## -0.626 -0.481 -0.302 -0.265 -0.273 -0.112 -0.353 -0.213  0.038 -0.120 -0.117 
    ##     12     13     14     15     16     17     18     19     20 
    ## -0.197 -0.132 -0.055 -0.109  0.022 -0.184 -0.067 -0.037 -0.024

=\> lag 9에서 절단되므로 p=8 =\> ARIMA(8,0)

#### 4. ARIMA 모형

-   auto.arima(x) \# forecast 패키지

    자동으로 ARIMA(p,d,q) 설정

``` r
#install.packages('forecast')
library(forecast)

auto.arima(Nile)
```

    ## Series: Nile 
    ## ARIMA(1,1,1) 
    ## 
    ## Coefficients:
    ##          ar1      ma1
    ##       0.2544  -0.8741
    ## s.e.  0.1194   0.0605
    ## 
    ## sigma^2 = 20177:  log likelihood = -630.63
    ## AIC=1267.25   AICc=1267.51   BIC=1275.04

=\> 자동으로 ARIMA(1,1,1) 선택

-   arima(x, oreder=c(p,d,q))

    -   order : ARIMA(p,d,q) 설정

``` r
Nile.arima <- arima(Nile, order = c(1,1,1))
Nile.arima
```

    ## 
    ## Call:
    ## arima(x = Nile, order = c(1, 1, 1))
    ## 
    ## Coefficients:
    ##          ar1      ma1
    ##       0.2544  -0.8741
    ## s.e.  0.1194   0.0605
    ## 
    ## sigma^2 estimated as 19769:  log likelihood = -630.63,  aic = 1267.25

-   forecaset(object, …) \# forecast 패키지

    arima 결과를 활용한 forecast 예측

``` r
# 10개년도 예측
Nile.forecast <- forecast(Nile.arima,h=10)
Nile.forecast
```

    ##      Point Forecast    Lo 80     Hi 80    Lo 95    Hi 95
    ## 1971       816.1813 635.9909  996.3717 540.6039 1091.759
    ## 1972       835.5596 642.7830 1028.3363 540.7332 1130.386
    ## 1973       840.4889 643.5842 1037.3936 539.3492 1141.629
    ## 1974       841.7428 642.1115 1041.3741 536.4331 1147.053
    ## 1975       842.0617 640.0311 1044.0923 533.0826 1151.041
    ## 1976       842.1429 637.8116 1046.4741 529.6452 1154.641
    ## 1977       842.1635 635.5748 1048.7522 526.2134 1158.114
    ## 1978       842.1687 633.3514 1050.9861 522.8102 1161.527
    ## 1979       842.1701 631.1488 1053.1914 519.4408 1164.899
    ## 1980       842.1704 628.9682 1055.3727 516.1057 1168.235

``` r
plot(Nile.forecast)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-16-1.png)

파란 영역 : 80% 신뢰구간

회색 영역 : 95% 신뢰구간

-   모형 진단(모형 타당성 검정)

1.  잔차가 백색 잡음(white noise) 검정  
    (모형의 잔차가 불규칙적이고, 독립적)

``` r
# 1) 자기상관함수에 의한 모형 진단
tsdiag(Nile.arima)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-17-1.png)

=\> ACF(자기상관함수)에서 모든 lag가 파란선 안에 들어와있음  
= 자기 상관관계 없음 (불규칙성)

=\> p-value 값이 0 이상에 분포  
= 모델 적합

``` r
# 2) Box-Ljung에 의한 잔차항 모형 진단
Box.test(Nile.arima$residuals, type = 'Ljung')
```

    ## 
    ##  Box-Ljung test
    ## 
    ## data:  Nile.arima$residuals
    ## X-squared = 0.10739, df = 1, p-value = 0.7431

=\> <u>p-value \> 0.05</u>이므로 모델 적합(<u>모형이 통계적으로
적절</u>)

#### 5. SARIMA (모름)

<https://otexts.com/fppkr/seasonal-arima.html>

SARIMA(Seasonal ARIMA) : 계절성 부분을 포함한 ARIMA 모형

astsa 패키지  
-   sarima(xdata ,p,d,q, P,D,Q, S) : 비계절/계절형 arima

    -   p,d,q : arima(p,d,q)

    -   P,D,Q : 계절성 P,D,Q

    -   S : 계절 주기

-   acf2(series, lag) : ACF, PACF 그래프

``` r
#install.packages('astsa')
library(astsa)
```

    ## 
    ## Attaching package: 'astsa'

    ## The following object is masked from 'package:forecast':
    ## 
    ##     gas

``` r
#install.packages('fpp')
library(fpp) # for data 
```

    ## Loading required package: fma

    ## 
    ## Attaching package: 'fma'

    ## The following objects are masked from 'package:astsa':
    ## 
    ##     chicken, sales

    ## Loading required package: expsmooth

    ## Loading required package: lmtest

    ## Loading required package: tseries

    ## 
    ## Attaching package: 'fpp'

    ## The following object is masked from 'package:astsa':
    ## 
    ##     oil

``` r
data("euretail")
plot(euretail)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-19-1.png)

``` r
ts <- euretail
logts <- log(ts) # 분산제거
dlogts <- diff(logts, lag=4) # 주기 4 계절 계절성 차분, 계절성 제거
Ddlogts <- diff(dlogts) # 비계절성 차분, 추세 제거
plot.ts(cbind(ts,logts,dlogts,Ddlogts))
```

![](시계열_files/figure-markdown_github/unnamed-chunk-19-2.png)

``` r
# 차수 결정
acf2(ts,40)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-19-3.png)

    ##      [,1]  [,2]  [,3]  [,4]  [,5] [,6] [,7]  [,8]  [,9] [,10] [,11] [,12] [,13]
    ## ACF  0.96  0.91  0.87  0.82  0.76 0.69 0.63  0.57  0.50  0.43  0.38  0.33  0.27
    ## PACF 0.96 -0.07 -0.01 -0.07 -0.26 0.00 0.01 -0.02 -0.12 -0.01  0.08  0.01 -0.10
    ##      [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25]
    ## ACF   0.21  0.16  0.12  0.08  0.04  0.01 -0.02 -0.06 -0.11 -0.14 -0.17 -0.21
    ## PACF -0.05  0.05  0.00 -0.01  0.01 -0.01 -0.02 -0.23 -0.02  0.01 -0.04  0.01
    ##      [,26] [,27] [,28] [,29] [,30] [,31] [,32] [,33] [,34] [,35] [,36] [,37]
    ## ACF  -0.24 -0.27 -0.29 -0.32 -0.34 -0.36 -0.38 -0.40 -0.42 -0.42 -0.43 -0.44
    ## PACF  0.03 -0.01 -0.03 -0.07  0.04 -0.10 -0.07  0.02 -0.04  0.04  0.01 -0.04
    ##      [,38] [,39] [,40]
    ## ACF  -0.44 -0.43 -0.42
    ## PACF -0.01  0.01  0.04

``` r
acf2(Ddlogts, 40)
```

![](시계열_files/figure-markdown_github/unnamed-chunk-19-4.png)

    ##      [,1] [,2] [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10] [,11] [,12] [,13]
    ## ACF  0.25 0.23 0.10 -0.44 -0.09 -0.21 -0.11  0.07 -0.20  0.01  0.00 -0.15  0.12
    ## PACF 0.25 0.17 0.02 -0.55  0.14  0.01  0.06 -0.20 -0.23  0.05  0.19 -0.21 -0.12
    ##      [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25]
    ## ACF  -0.01 -0.03  0.04 -0.03  0.03  0.02  0.02  0.07 -0.03 -0.06  0.00 -0.12
    ## PACF  0.04  0.06 -0.14  0.03 -0.03  0.03 -0.03  0.00 -0.05 -0.09  0.01 -0.06
    ##      [,26] [,27] [,28] [,29] [,30] [,31] [,32] [,33] [,34] [,35] [,36] [,37]
    ## ACF  -0.07 -0.02 -0.03  0.05  0.10  0.18  0.14  0.12  0.07 -0.07 -0.09 -0.13
    ## PACF -0.05 -0.08  0.05  0.02  0.08  0.10 -0.02  0.04  0.03 -0.03 -0.01 -0.03
    ##      [,38] [,39] [,40]
    ## ACF   -0.1 -0.06 -0.06
    ## PACF   0.0  0.00  0.00

계절성 -\> ACF는 지수적 감소하므로 Q=0, PACF는 lag=2에서 절단되므로 P=1

비계절성 -\> ACF는 lag=2에서 절단되므로 q=1, PACF도 lag=2에서 절단되므로
p=1

``` r
sarima(logts,1,1,1,1,1,0,4)
```

    ## initial  value -5.180843 
    ## iter   2 value -5.348324
    ## iter   3 value -5.352456
    ## iter   4 value -5.375563
    ## iter   5 value -5.380184
    ## iter   6 value -5.389198
    ## iter   7 value -5.396425
    ## iter   8 value -5.398771
    ## iter   9 value -5.402111
    ## iter  10 value -5.403206
    ## iter  11 value -5.403333
    ## iter  12 value -5.403405
    ## iter  13 value -5.403406
    ## iter  13 value -5.403406
    ## iter  13 value -5.403406
    ## final  value -5.403406 
    ## converged
    ## initial  value -5.407298 
    ## iter   2 value -5.407580
    ## iter   3 value -5.407843
    ## iter   4 value -5.407902
    ## iter   5 value -5.407984
    ## iter   6 value -5.407997
    ## iter   7 value -5.407998
    ## iter   7 value -5.407999
    ## iter   7 value -5.407999
    ## final  value -5.407999 
    ## converged
    ## <><><><><><><><><><><><><><>
    ##  
    ## Coefficients: 
    ##      Estimate     SE t.value p.value
    ## ar1    0.7067 0.1495  4.7279  0.0000
    ## ma1   -0.3450 0.1731 -1.9937  0.0511
    ## sar1  -0.5495 0.1067 -5.1486  0.0000
    ## 
    ## sigma^2 estimated as 1.958624e-05 on 56 degrees of freedom 
    ##  
    ## AIC = -7.842527  AICc = -7.835131  BIC = -7.701677 
    ## 

![](시계열_files/figure-markdown_github/unnamed-chunk-20-1.png)
