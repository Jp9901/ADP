### 1절. 연관규칙

#### 1. 연관규칙분석(Association Analysis)의 개념

: 장바구니분석 or 서열분석, 사건들 간의 규칙을 발견하기 위해 적용

#### 2. 연관규칙의 형태

조건과 반응의 형태(IF-THEN)로 이루어짐

#### 3. 연관규칙의 측도

-   지지도(support)

    $$
    지지도 = P(A \cap B) = \frac{A \cap B}{전체}
    $$

-   신뢰도(confidence)  
    연관성의 정도를 파악

    $$
    신뢰도 = \frac{P(A \cap B)}{P(A)} = \frac{지지도}{P(A)}
    $$

-   향상도(Lift)

    $$
    향상도 = \frac{P(A \cap B)}{P(A)P(B)} = \frac{신뢰도}{P(B)}
    $$

=\> A와 B가 서로 관련이 없는 경우 향상도=1

#### 4. Apriori 알고리즘

빈발항목집합 : 최소 지지도보다 큰 지지도 값을 갖는 품목의 집합

빈발항목집합을 찾은 후 그것들에 대해서만 연관규칙 계산

#### 5. R을 이용한 연관분석

as함수(데이터 -\> 트랜젝션 형태) -\> apriori함수(연관분석) -\>
inspect함수(연관분석 결과)

-   as(data, class)

    -   data : 데이터 (**factor or logical** 변수)

    -   class : object를 변경할 클래스 이름 (연관분석 =\>
        ‘**transactions**’)

-   apriori(data, parameter, appearance, control) \# **arules 패키지**

    -   parameter : 최소 지지도(supp), 신뢰도(conf), 최대 아이템
        개수(maxlen), 최소 아이템 개수(minlen)

    -   appearance : 특정 연관규칙 결과를 찾을 수 있음

    -   control : 결과 보여주기 등의 알고리즘의 성능을 조정할 수 있음

-   inspect(x,…) \# **arules 패키지**

``` r
# as함수(데이터 변경) + inspect함수(데이터 확인)

#install.packages('arules')
library(arules)
```

    ## Loading required package: Matrix

    ## 
    ## Attaching package: 'arules'

    ## The following objects are masked from 'package:base':
    ## 
    ##     abbreviate, write

``` r
age <- c('age_20','age_20','age_40','age_30')
rank <- c('Gold','Silver','Silver','VIP')
mobile_app_use <- c('Yes','Yes','No','Yes')

cust_tel <- cbind(age,rank,mobile_app_use)
cust_tel <- as.data.frame(cust_tel)
cust_tel[,1] <- as.factor(cust_tel[,1])
cust_tel[,2] <- as.factor(cust_tel[,2])
cust_tel[,3] <- as.factor(cust_tel[,3])
str(cust_tel)
```

    ## 'data.frame':    4 obs. of  3 variables:
    ##  $ age           : Factor w/ 3 levels "age_20","age_30",..: 1 1 3 2
    ##  $ rank          : Factor w/ 3 levels "Gold","Silver",..: 1 2 2 3
    ##  $ mobile_app_use: Factor w/ 2 levels "No","Yes": 2 2 1 2

``` r
tran.cust <- as(cust_tel,'transactions')
inspect(tran.cust)
```

    ##     items                                         transactionID
    ## [1] {age=age_20, rank=Gold, mobile_app_use=Yes}   1            
    ## [2] {age=age_20, rank=Silver, mobile_app_use=Yes} 2            
    ## [3] {age=age_40, rank=Silver, mobile_app_use=No}  3            
    ## [4] {age=age_30, rank=VIP, mobile_app_use=Yes}    4

``` r
# apriori
library(arules)

data("Groceries")
Groceries # transactions data
```

    ## transactions in sparse format with
    ##  9835 transactions (rows) and
    ##  169 items (columns)

``` r
inspect(Groceries[1:3])
```

    ##     items                 
    ## [1] {citrus fruit,        
    ##      semi-finished bread, 
    ##      margarine,           
    ##      ready soups}         
    ## [2] {tropical fruit,      
    ##      yogurt,              
    ##      coffee}              
    ## [3] {whole milk}

``` r
groc.rule <- apriori(Groceries,
                     parameter = list(support=0.01,
                                      confidence=0.3))
```

    ## Apriori
    ## 
    ## Parameter specification:
    ##  confidence minval smax arem  aval originalSupport maxtime support minlen
    ##         0.3    0.1    1 none FALSE            TRUE       5    0.01      1
    ##  maxlen target  ext
    ##      10  rules TRUE
    ## 
    ## Algorithmic control:
    ##  filter tree heap memopt load sort verbose
    ##     0.1 TRUE TRUE  FALSE TRUE    2    TRUE
    ## 
    ## Absolute minimum support count: 98 
    ## 
    ## set item appearances ...[0 item(s)] done [0.00s].
    ## set transactions ...[169 item(s), 9835 transaction(s)] done [0.00s].
    ## sorting and recoding items ... [88 item(s)] done [0.00s].
    ## creating transaction tree ... done [0.00s].
    ## checking subsets of size 1 2 3 4 done [0.00s].
    ## writing ... [125 rule(s)] done [0.00s].
    ## creating S4 object  ... done [0.00s].

``` r
# => 125 rule(s)개의 연관규칙 생성

inspect(sort(groc.rule,by=c('confidence'),decreasing = T)[1:5])
```

    ##     lhs                                  rhs                support   
    ## [1] {citrus fruit, root vegetables}   => {other vegetables} 0.01037112
    ## [2] {tropical fruit, root vegetables} => {other vegetables} 0.01230300
    ## [3] {curd, yogurt}                    => {whole milk}       0.01006609
    ## [4] {other vegetables, butter}        => {whole milk}       0.01148958
    ## [5] {tropical fruit, root vegetables} => {whole milk}       0.01199797
    ##     confidence coverage   lift     count
    ## [1] 0.5862069  0.01769192 3.029608 102  
    ## [2] 0.5845411  0.02104728 3.020999 121  
    ## [3] 0.5823529  0.01728521 2.279125  99  
    ## [4] 0.5736041  0.02003050 2.244885 113  
    ## [5] 0.5700483  0.02104728 2.230969 118

※ confidence가 높다 = 구매 품목들의 연관성이 높다.

※ lift가 높다 = 좌항을 구매할 때, 유항을 구매할 확률이 약 n배 가량 높다.

=\> (좌항-\>우항), (우항-\>좌항)이 겹치는 경우가 있으므로 중복 규칙 제거

``` r
# 중복가지치기 함수
prune.dup.rules <- function(rules){
  rule.subset.matrix <- is.subset(rules, rules, sparse = FALSE)
  rule.subset.matrix[lower.tri(rule.subset.matrix, diag=T)] <- NA
  dup.rules <- colSums(rule.subset.matrix, na.rm = T) >= 1
  pruned.rules <- rules[!dup.rules]
  return(pruned.rules)
}
```

``` r
# 특정 우측 값의 연관성 파악
metric.params <- list(supp=0.001, conf=0.5, minlen=2)
groc.rule2 <- apriori(data=Groceries, parameter = metric.params,
                      appearance = list(default='lhs',
                                        rhs='soda'), # 우측='soda'
                      control = list(verbose=F))

groc.rule2 <- prune.dup.rules(groc.rule2) # 중복가지치기
inspect(sort(groc.rule2,by='confidence',decreasing = T)[1:5])
```

    ##     lhs                                       rhs    support     confidence
    ## [1] {coffee, misc. beverages}              => {soda} 0.001016777 0.7692308 
    ## [2] {sausage, bottled water, bottled beer} => {soda} 0.001118454 0.7333333 
    ## [3] {sausage, white bread, shopping bags}  => {soda} 0.001016777 0.6666667 
    ## [4] {rolls/buns, bottled water, chocolate} => {soda} 0.001321810 0.6500000 
    ## [5] {pastry, misc. beverages}              => {soda} 0.001220132 0.6315789 
    ##     coverage    lift     count
    ## [1] 0.001321810 4.411303 10   
    ## [2] 0.001525165 4.205442 11   
    ## [3] 0.001525165 3.823129 10   
    ## [4] 0.002033554 3.727551 13   
    ## [5] 0.001931876 3.621912 12

``` r
# 특정 좌측 값의 연관성 파악
metric.params <- list(supp=0.001, conf=0.3, minlen=2)
groc.rule3 <- apriori(data=Groceries, parameter = metric.params,
                      appearance = list(default='rhs',
                                        lhs=c('yogurt','sugar')),
                                        # 좌측=yogurt|sugar
                      control = list(verbose=F))

groc.rule3 <- prune.dup.rules(groc.rule3) # 중복가지치기
inspect(sort(groc.rule3,by='confidence',decreasing = T)[1:5])
```

    ##     lhs                rhs                  support     confidence coverage   
    ## [1] {sugar}         => {whole milk}         0.015048297 0.4444444  0.033858668
    ## [2] {yogurt}        => {whole milk}         0.056024403 0.4016035  0.139501779
    ## [3] {sugar}         => {other vegetables}   0.010777834 0.3183183  0.033858668
    ## [4] {yogurt}        => {other vegetables}   0.043416370 0.3112245  0.139501779
    ## [5] {yogurt, sugar} => {whipped/sour cream} 0.002135231 0.3088235  0.006914082
    ##     lift     count
    ## [1] 1.739400 148  
    ## [2] 1.571735 551  
    ## [3] 1.645119 106  
    ## [4] 1.608457 427  
    ## [5] 4.308198  21
